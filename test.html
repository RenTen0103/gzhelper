<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>

</body>
<script>
    function getBase64Image(img) {
        var canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        var ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, img.width, img.height);
        var dataURL = canvas.toDataURL("image/png");
        return dataURL

    }

    const pMessage = (message) => {
        window.ReactNativeWebView.postMessage(JSON.stringify(message))
    }



    const asyncGetElement = async (Selector) => {
        return new Promise((resolve, reject) => {
            let count = 0;
            let timer = setInterval(() => {
                count++;
                if (count > 20) {
                    clearInterval(timer)
                    reject("Time out!cannot find element!")
                }

                if (document.querySelector("#iframeautoheight").contentDocument.querySelector(Selector)) {
                    clearInterval(timer)
                    resolve(document.querySelector("#iframeautoheight").contentDocument.querySelector(Selector))
                }
                if (document.querySelector(Selector)) {
                    clearInterval(timer)
                    resolve(document.querySelector(Selector))
                }
            }, 300);
        })
    }


    const ansSchedule = (m) => {
        let values = []
        for (let index = m.children.length - 7; index < m.children.length; index++) {
            let preBr = false
            const element = m.children[index];
            let v = []
            let b = []
            element.childNodes.forEach(e => {
                if (e.nodeName == '#text') {
                    preBr = false
                    b.push(e.nodeValue)
                }

                if (e.nodeName == 'BR') {
                    if (preBr == true) {
                        console.log(b);
                        v.push(b.concat())
                        b.length = 0
                        b = []

                    }
                    preBr = true
                }


            },

            );

            v.push(b)
            values.push(v)
        }

        return values
    }

    const getSchedule = async () => {
        document.querySelector('#headDiv > ul > li:nth-child(5) > ul > li:nth-child(2) > a').click()
        let m1 = await asyncGetElement('#Table1 > tbody > tr:nth-child(3)')
        let m2 = await asyncGetElement('#Table1 > tbody > tr:nth-child(5)')
        let m3 = await asyncGetElement('#Table1 > tbody > tr:nth-child(7)')
        let m4 = await asyncGetElement('#Table1 > tbody > tr:nth-child(9)')
        let m5 = await asyncGetElement('#Table1 > tbody > tr:nth-child(11)')
        let values = []
        values.push(ansSchedule(m1))
        values.push(ansSchedule(m2))
        values.push(ansSchedule(m3))
        values.push(ansSchedule(m4))
        values.push(ansSchedule(m5))

        pMessage({
            key: "getSchedule",
            data: JSON.stringify(values),
        })

    }


    const resite = ()=>{
        window.location.href = "https://jw.gzu.edu.cn/default2.aspx"
    }

    const login = (acc, psd, cc) => {
        if (document.readyState != "complete") {

            document.onreadystatechange = () => {
                if (document.readyState == "complete") {
                    login(acc, psd, cc)
                }
            }
        } else {
            let w = setInterval(() => {
                pMessage({
                    key: 'message',
                    data: "wait!"
                })
                if (document.getElementById('TextBox2')) {
                    clearInterval(w)
                    document.getElementById("txtUserName").value = acc
                    document.getElementById("txtSecretCode").value = cc
                    document.getElementById('TextBox2').value = psd
                    document.getElementById("Button1").click()
                }
            }, 300);

        }



    }

    function stringToUint8Array(str) {
        var arr = [];
        for (var i = 0, j = str.length; i < j; ++i) {
            arr.push(str.charCodeAt(i));
        }

        var tmpUint8Array = new Uint8Array(arr);
        return tmpUint8Array
    }
    const quryscore = () => {
        document.querySelector("#headDiv > ul > li:nth-child(5) > ul > li:nth-child(4) > a").click()
        let w = setInterval(() => {

            if (document.querySelector("#iframeautoheight").contentDocument.querySelector("#Button1")) {

                clearInterval(w)
                document.querySelector("#iframeautoheight").contentDocument.querySelector("#Button1").click()
                let org = document.querySelector("#iframeautoheight").contentDocument.querySelector("#Form1 > input[type=hidden]").getAttribute("value")
                let q = setInterval(() => {

                    if (document.querySelector("#iframeautoheight").contentDocument.querySelector("#Form1 > input[type=hidden]").getAttribute("value") != org) {
                        let code = []
                        let i = 2;
                        while (true) {
                            let l = document.querySelector("#iframeautoheight").contentDocument.querySelector("#Datagrid1 > tbody > tr:nth-child(" + i + ") > td:nth-child(3)")
                            if (!l) {
                                break
                            } else {
                                code.push(l.innerText)
                            }
                            i++
                        }

                        clearInterval(q)
                        pMessage({
                            key: "quryScore",
                            data: {
                                org: new TextDecoder('utf-8').decode(stringToUint8Array(window.atob(document.querySelector("#iframeautoheight").contentDocument.querySelector("#Form1 > input[type=hidden]").getAttribute("value")))),
                                code: code
                            }
                        })
                    }
                }, 500)
            }
        }, 500)

    }

    window.alert = (e) => {
        pMessage({
            key: "login",
            data: e,
        })
    }



    document.addEventListener("message", (e) => {

        data = JSON.parse(e.data)
        pMessage(data.type)
        switch (data.type) {
            case "login":
                login(data.data.account, data.data.passwd, data.data.checkCode)
                break;
            case "getCheckCode":
                pMessage({
                    key: 'getCheckCode',
                    data: getBase64Image(document.getElementById('icode'))
                })

                break;
            case "quryScore":
                quryscore()
                break;
            case "getSchedule":
                getSchedule()
                break
            case "resite":
                resite()
                break
            default:
                break;
        }
    });

    window.onload = () => {
        if (window.location.href.startsWith('https://jw.gzu.edu.cn/xs_main.aspx')) {
            pMessage({
                key: "login",
                data: "sucess"
            })
        }

    }

</script>

</html>